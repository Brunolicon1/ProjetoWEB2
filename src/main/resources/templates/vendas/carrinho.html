<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragmentos/layout :: layout(~{::head}, ~{::main}, false)}">

<head th:replace="~{fragmentos/head :: common_head('Carrinho de Compras')}">
</head>

<body>

<main th:fragment="main" class="flex-grow container mx-auto py-10 px-4">

    <div class="flex items-center gap-4 mb-8">
        <h1 class="text-3xl font-bold text-gray-100">Carrinho de Compras</h1>
        <span class="bg-emerald-600 text-white text-sm font-bold px-3 py-1 rounded-full"
              th:text="${venda.itens.size()} + ' Itens'">0 Itens</span>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <div class="lg:col-span-2 space-y-4">

            <div th:if="${venda.itens.isEmpty()}" class="bg-[#2b2d31] border border-gray-700 p-10 rounded-xl text-center">
                <p class="text-gray-400 text-lg mb-4">O seu carrinho está vazio.</p>
                <a th:href="@{/vendas/form}" class="text-emerald-400 hover:text-emerald-300 underline">
                    Ir para o catálogo
                </a>
            </div>

            <div th:unless="${venda.itens.isEmpty()}" class="bg-[#2b2d31] border border-gray-700 rounded-xl overflow-hidden shadow-lg">
                <table class="w-full text-left">
                    <thead class="bg-gray-800 text-gray-400 uppercase text-xs font-semibold">
                    <tr>
                        <th class="px-6 py-4">Produto</th>
                        <th class="px-6 py-4 text-center">Quantidade</th>
                        <th class="px-6 py-4 text-right">Unitário</th>
                        <th class="px-6 py-4 text-right">Total</th>
                        <th class="px-6 py-4 text-center">Ações</th>
                    </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700 text-gray-300">
                    <tr th:each="item : ${venda.itens}" class="hover:bg-gray-700/50 transition-colors">

                        <td class="px-6 py-4">
                            <div class="font-medium text-white" th:text="${item.produto.descricao}">Produto</div>
                            <div class="text-xs text-gray-500" th:text="'Ref: ' + ${item.produto.id}">Ref</div>
                        </td>

                        <td class="px-6 py-4 text-center">
                            <form th:action="@{/vendas/atualizar-item}" method="post" class="flex justify-center">
                                <input type="hidden" name="produtoId" th:value="${item.produto.id}">

                                <input type="number" name="quantidade"
                                       th:value="${item.quantidade}"
                                       min="1"
                                       class="w-20 text-center bg-gray-900 border border-gray-600 rounded-md text-white py-1 focus:ring-2 focus:ring-emerald-500 outline-none"
                                       onchange="this.form.submit()"> </form>
                        </td>

                        <td class="px-6 py-4 text-right"
                            th:text="${#numbers.formatCurrency(item.produto.valor)}">R$ 0,00</td>

                        <td class="px-6 py-4 text-right font-bold text-emerald-400"
                            th:text="${#numbers.formatCurrency(item.total())}">R$ 0,00</td>

                        <td class="px-6 py-4 text-center">
                            <a th:href="@{/vendas/remover-item/{id}(id=${item.produto.id})}"
                               class="text-red-400 hover:text-red-300 hover:bg-red-900/30 p-2 rounded-full transition-colors"
                               title="Remover Item">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                </svg>
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>

                <div class="bg-gray-800 px-6 py-4 text-right">
                    <a th:href="@{/vendas/form}" class="text-sm text-emerald-400 hover:text-emerald-300 font-medium">
                        + Continuar comprando
                    </a>
                </div>
            </div>
        </div>

        <div class="lg:col-span-1">
            <div class="bg-[#2b2d31] border border-gray-700 rounded-xl p-6 shadow-xl sticky top-6">

                <h2 class="text-xl font-semibold text-white mb-6 border-b border-gray-700 pb-2">
                    <span th:if="${venda.id == 0}">Resumo do Pedido</span>
                    <span th:if="${venda.id != 0}" class="text-yellow-400">Editando Venda #<span th:text="${venda.id}"></span></span>
                </h2>

                <div class="space-y-6">

                    <form th:action="@{/vendas/set-pessoa}" method="post">
                        <label for="pessoa" class="block text-sm font-medium text-gray-400 mb-1">Cliente</label>
                        <select id="pessoa" name="pessoaId"
                                onchange="this.form.submit()"
                                class="w-full px-4 py-2 bg-[#1e1f22] border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                            <option value="" disabled th:selected="${venda.pessoa == null}">Selecione o cliente...</option>
                            <option th:each="p : ${pessoas}"
                                    th:value="${p.id}"
                                    th:text="${p.nome}"
                                    th:selected="${venda.pessoa != null and venda.pessoa.id == p.id}">
                            </option>
                        </select>
                    </form>

                    <form th:action="@{/vendas/set-data}" method="post">
                        <label for="data" class="block text-sm font-medium text-gray-400 mb-1">Data da Venda</label>
                        <input type="date" id="data" name="data"
                               onchange="this.form.submit()"
                               th:value="${venda.data}"
                               class="w-full px-4 py-2 bg-[#1e1f22] border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:outline-none">
                    </form>

                    <form th:action="@{/vendas/save}" method="post">

                        <input type="hidden" name="id" th:value="${venda.id}">

                        <input type="hidden" name="pessoaId" th:if="${venda.pessoa != null}" th:value="${venda.pessoa.id}">
                        <input type="hidden" name="data" th:value="${venda.data}">

                        <div class="border-t border-gray-700 pt-4 mt-4 space-y-2">
                            <div class="flex justify-between text-gray-400">
                                <span>Subtotal</span>
                                <span th:text="${#numbers.formatCurrency(venda.total())}">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between text-white text-xl font-bold pt-2">
                                <span>Total</span>
                                <span th:text="${#numbers.formatCurrency(venda.total())}">R$ 0,00</span>
                            </div>
                        </div>

                        <button type="submit" th:if="${venda.id == 0}"
                                th:disabled="${venda.itens.isEmpty() or venda.pessoa == null}"
                                class="w-full mt-6 bg-emerald-600 hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed
                                       text-white font-bold py-3 rounded-lg shadow-lg transition-all duration-300">
                            Finalizar Venda
                        </button>

                        <button type="submit" th:if="${venda.id != 0}"
                                th:disabled="${venda.itens.isEmpty() or venda.pessoa == null}"
                                class="w-full mt-6 bg-yellow-600 hover:bg-yellow-700 disabled:opacity-50 disabled:cursor-not-allowed
                                       text-white font-bold py-3 rounded-lg shadow-lg transition-all duration-300">
                            Salvar Alterações
                        </button>

                        <p th:if="${venda.pessoa == null}" class="text-xs text-red-400 text-center mt-2">
                            Selecione um cliente para finalizar.
                        </p>

                    </form>
                </div>
            </div>
        </div>

    </div>

</main>

</body>
</html>